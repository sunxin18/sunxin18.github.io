class FileExplorerFooterOpen{constructor(root,$file_explorer){this.root=root,this.$footer=$file_explorer.find(".file-explorer-info"),this.$file_input=this.$footer.find(".file-explorer-info-tilte-input"),this.$btn_open=this.$footer.find(".file-explorer-info-submit-btn-open"),this.$btn_cancel=this.$footer.find(".file-explorer-info-submit-btn-cancel"),desktop_state.window.rename(root.window_id,root.type),this.$file_input.attr("readonly","readonly"),this.selected_files=[],this.add_listening_events()}add_listening_events(){let outer_obj=this;this.$btn_open.click(function(){if(!(outer_obj.selected_files.length>0))return!1;outer_obj.selected_files[0].open(),outer_obj.$file_input.val("")}),this.$btn_cancel.click(function(){desktop_state.window.close(outer_obj.root,window_id)})}select_file(file){this.$file_input.val(file.get_full_file_name()),this.selected_files=[file]}}class FileExplorerFooterSave{constructor(root,$file_explorer){this.root=root,this.$footer=$file_explorer.find(".file-explorer-info")}}class FileExplorerMainFile{constructor(root,file){this.root=root,this.id=file.id,this.title=file.title,this.type=file.type,this.modifytime=file.modifytime,this.icon=file.icon,this.mode=file.mode,"文件夹"===file.type&&(this.address=file.address),this.$file=null,this.$icon=null,this.$title=null,this.last_click_time=null}get_ext(){let type=this.type;return"Cpp代码"===type?"cpp":"Java代码"===type?"java":"Python代码"===type?"py":"Python3代码"===type?"py3":"C代码"===type?"c":"Javascript代码"===type?"js":"Go代码"===type?"go":"题解"===type?"sln":"文本"===type?"txt":"问题"===type?"ques":"题目"===type?"prob":"题目讨论"===type?"prob.dis":"视频"===type?"mp4":"打卡代码"===type?"act.code":"文件夹"===type?"":"应用"===type?"app":"other"}get_full_file_name(){let ext=this.get_ext();return ext?this.title+"."+ext:this.title}open(type){if("文件夹"===this.type)if("outer_window"===type){let w_obj=desktop_state.window.windows[this.root.window_id];desktop_state.window.open_outer_window(w_obj.file_id,`main&address=${this.address}`)}else this.root.main.field.clear(),this.root.main.field.load(this.address,"new");else{if(new Set(["Cpp代码","Java代码","Python代码","Python3代码","C代码","Javascript代码","Go代码"]).has(this.type))if("打开"===this.root.type){let w_obj=desktop_state.window.windows[this.root.window_id],p_obj=desktop_state.window.windows[w_obj.parent_window_id].obj;new AcEditorWorkspaceProjectMainNavFile.open(p_obj,this.id,this.type),desktop_state.window.close(this.root.window_id)}else{let ac_editor_id=desktop_state.os.builtin.application.applications.ac_editor;desktop_state.window.open_outer_window(ac_editor_id,`main&file_id=${this.id}`)}else desktop_state.window.open(this.id)}}rename(){let outer_obj=this;this.$title.hide();let $textarea=$(`<textarea class="file-explorer-main-field-item-textarea">${this.title}</textarea>`);this.$file.append($textarea),$textarea.focus(),$textarea.select(),$textarea.dblclick(function(e){return e.stopPropagation(),e.preventDefault(),!1});let has_rename_to_sever=!1,rename_to_server=function(){if(has_rename_to_sever)return!1;has_rename_to_sever=!0,$.ajax({type:"POST",url:desktop_state.os.builtin.api.file.operation.update_refactor_rename,data:{data:JSON.stringify({file_id:outer_obj.id,title:$textarea.val()})},dataType:"json",success:function(resp){if("success"===resp.error_message)outer_obj.title=$textarea.val(),outer_obj.$title.text(outer_obj.get_full_file_name());else{let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text="+resp.error_message)}$textarea.hide(),outer_obj.$title.show()},error:function(){let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text=系统出现异常，请稍后重试"),$textarea.hide(),outer_obj.$title.show()}})};$textarea.blur(function(){rename_to_server()}),$textarea.keydown(function(e){13===e.which&&rename_to_server()})}}class FileExplorerMainFieldFile extends FileExplorerMainFile{constructor(root,file){super(root,file),this.render()}render(){this.$file=$('<div class="file-explorer-main-field-item"><div class="file-explorer-main-field-item-icon">'+`<img src="${this.icon}" alt="文件图标"/>`+"</div>"+`<div class="file-explorer-main-field-item-title">${this.get_full_file_name()}</div>`+"</div>"),this.$icon=this.$file.find(".file-explorer-main-field-item-icon"),this.$title=this.$file.find(".file-explorer-main-field-item-title")}}class FileExplorerMainField{constructor(root,$main){this.root=root,this.$field=$main.find(".file-explorer-main-field"),this.files=[],this.selected_files=new Map,this.last_selected_file=null,this.shift_selected_anchor=null,this.init_events()}init_events(){let outer_obj=this;this.$field.click(function(){outer_obj.unselect_files()}),this.$field.contextmenu(function(e){return outer_obj.field_contextmenu(e),e.stopPropagation(),e.preventDefault(),!1}),$(window).mousedown(function(e){$(".file-explorer-main-field-context-menu").remove()}),$(window).keydown(function(e){if(desktop_state.window.is_focus(outer_obj.root.window_id)){if(e.ctrlKey&&88===e.which)return outer_obj.cut(),!1;if(e.ctrlKey&&67===e.which)return outer_obj.copy(),!1;if(e.ctrlKey&&86===e.which)return outer_obj.paste(),!1;if(e.ctrlKey&&82===e.which)return outer_obj.refresh(),!1;46===e.which&&outer_obj.delete_files()}}),this.$field.on("mousewheel DOMMouseScroll",function(e){let e0=e.originalEvent,delta=e0.wheelDelta||-e0.detail;this.scrollTop+=50*(delta<0?1:-1),e.preventDefault()})}clear(){this.$field.empty(),this.files=[]}render_files(files){for(let i=0;i<files.length;i++){let file=files[i],file_obj=new FileExplorerMainFieldFile(this.root,file);this.files.push(file_obj),this.$field.append(file_obj.$file),this.add_listening_events(file_obj)}}refresh(){this.clear();let address=this.root.nav.get_address().real;address&&this.load(address,"refresh")}}FileExplorerMainField.prototype.add_listening_events=function(file_obj){let outer_obj=this,$file=file_obj.$file;$file.mousedown(function(e){return outer_obj.select_files(e,$file,file_obj),e.stopPropagation(),e.preventDefault(),!1}),$file.dblclick(function(e){return file_obj.open(),e.stopPropagation(),e.preventDefault(),!1}),$file.contextmenu(function(e){return outer_obj.file_contextmenu(e,$file,file_obj),e.stopPropagation(),e.preventDefault(),!1}),file_obj.$icon.click(function(e){return 1===outer_obj.selected_files.size&&outer_obj.selected_files.has($file)&&(file_obj.last_record_time=(new Date).getDate()),"打开"===file_obj.root.type&&file_obj.root.footer.select_file(file_obj),e.preventDefault(),!1}),file_obj.$title.click(function(e){return 1===outer_obj.selected_files.size&&outer_obj.selected_files.has($file)&&(file_obj.last_record_time&&(new Date).getTime()-file_obj.last_record_time>300&&file_obj.rename(),file_obj.last_record_time=(new Date).getTime()),"打开"===file_obj.root.type&&file_obj.root.footer.select_file(file_obj),e.preventDefault(),!1})},FileExplorerMainField.prototype.cut=function(){let files=Array.from(this.selected_files.values());files.length>0&&desktop_state.os.builtin.memory.clipboard.cut(files,this.root.window_id)},FileExplorerMainField.prototype.copy=function(){let files=Array.from(this.selected_files.values());files.length>0&&desktop_state.os.builtin.memory.clipboard.copy(files,this.root.window_id)},FileExplorerMainField.prototype.paste=function(){let folder_id=this.root.nav.get_current_folder(),outer_obj=this,records=desktop_state.os.builtin.memory.clipboard.records,length=records.length;if(length>0){let op_url,record=records[length-1];op_url="copy"===record.type?desktop_state.os.builtin.api.file.operation.command_cp:desktop_state.os.builtin.api.file.operation.command_mv;let file_ids=[];for(let i=0;i<record.files.length;i++)file_ids.push(record.files[i].id);$.ajax({type:"POST",url:op_url,data:{data:JSON.stringify({src:file_ids,dst:folder_id})},dataType:"json",success:function(resp){if("success"===resp.error_message){let responses=resp.resps,file_ids=[];for(let i=0;i<responses.length;i++){let response=responses[i];if("success"===response.error_message){let file_id=response.file_id;if(0===response.depth){if("cut"===record.type){desktop_state.window.windows[record.window_id].builtin_obj.main.field.delete_file(file_id)}file_ids.push(file_id)}}else{let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text="+response.error_message)}}outer_obj.append(file_ids)}else{let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text="+resp.error_message)}},error:function(resp){let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text=系统出现异常，请稍后重试")}})}desktop_state.os.builtin.memory.clipboard.paste()},FileExplorerMainField.prototype.delete_file=function(file_id){for(let i=0;i<this.files.length;i++)if(this.files[i].id===file_id){this.files[i].$file.remove(),this.files.splice(i,1);break}},FileExplorerMainField.prototype.delete_files=function(){let outer_obj=this,file_ids=[];outer_obj.selected_files.forEach(function(value,key){file_ids.push(value.id)}),$.ajax({type:"POST",url:desktop_state.os.builtin.api.file.operation.delete,data:{data:JSON.stringify({file_ids})},dataType:"json",success:function(resp){if("success"===resp.error_message){let responses=resp.resps;for(let i=0;i<responses.length;i++){let response=responses[i];if("success"===response.error_message){let file_id=response.file_id;0===response.depth&&outer_obj.delete_file(file_id)}else{let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text="+response.error_message)}}}else{let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text="+resp.error_message)}desktop_state.os.builtin.memory.clipboard.paste()},error:function(resp){let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text=系统出现异常，请稍后重试")}})},FileExplorerMainField.prototype.field_contextmenu=function(e){$(".file-explorer-main-field-context-menu").remove();let vw=$(window).width(),vh=$(window).height(),left=e.pageX-.1*vw,top=e.pageY-$(document).scrollTop();left<0&&(left=0);let disable_paste=!0;desktop_state.os.builtin.memory.clipboard.records.length>0&&(disable_paste=!1);let $menu=$(`<ul class="file-explorer-main-field-context-menu" style="left: ${left}px; top: ${top}px;">`+'<li><div class="file-explorer-main-field-context-menu-refresh">刷新</div></li>'+`<li class="${disable_paste?"ui-state-disabled":""}"><div class="file-explorer-main-field-context-menu-paste">粘贴</div></li>`+'<li><div class="file-explorer-main-field-context-menu-new">新建</div><ul><li><div class="file-explorer-main-field-context-menu-new-folder">文件夹</div></li><li class="divider"></li><li><div class="file-explorer-main-field-context-menu-new-code-cpp">Cpp</div></li><li><div class="file-explorer-main-field-context-menu-new-code-java">Java</div></li><li><div class="file-explorer-main-field-context-menu-new-code-python">Python</div></li><li><div class="file-explorer-main-field-context-menu-new-code-python3">Python3</div></li><li><div class="file-explorer-main-field-context-menu-new-code-c">C</div></li><li><div class="file-explorer-main-field-context-menu-new-code-javascript">Javascript</div></li><li><div class="file-explorer-main-field-context-menu-new-code-go">Go</div></li></ul></li></ul>');$menu.appendTo(this.root.main.field.$field),$menu.height()+top>.9*vh&&$menu.css("top",.9*vh-$menu.height()+"px"),$menu.menu();let outer_obj=this;$menu.find(".file-explorer-main-field-context-menu-refresh").click(function(){return outer_obj.refresh(),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-paste").click(function(){return!1===disable_paste&&(outer_obj.paste(),$menu.remove()),!1}),$menu.find(".file-explorer-main-field-context-menu-new-folder").click(function(){return outer_obj.new_folder(),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-new-code-cpp").click(function(){return desktop_state.window.open_outer_window(desktop_state.os.builtin.application.applications.ac_editor,"main&file_id=0&file_type=Cpp代码"),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-new-code-java").click(function(){return desktop_state.window.open_outer_window(desktop_state.os.builtin.application.applications.ac_editor,"main&file_id=0&file_type=Java代码"),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-new-code-python").click(function(){return desktop_state.window.open_outer_window(desktop_state.os.builtin.application.applications.ac_editor,"main&file_id=0&file_type=Python代码"),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-new-code-python3").click(function(){return desktop_state.window.open_outer_window(desktop_state.os.builtin.application.applications.ac_editor,"main&file_id=0&file_type=Python3代码"),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-new-code-c").click(function(){return desktop_state.window.open_outer_window(desktop_state.os.builtin.application.applications.ac_editor,"main&file_id=0&file_type=C代码"),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-new-code-javascript").click(function(){return desktop_state.window.open_outer_window(desktop_state.os.builtin.application.applications.ac_editor,"main&file_id=0&file_type=Javascript代码"),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-new-code-go").click(function(){return desktop_state.window.open_outer_window(desktop_state.os.builtin.application.applications.ac_editor,"main&file_id=0&file_type=Go代码"),$menu.remove(),!1}),$menu.mousedown(function(e){return e.stopPropagation(),e.preventDefault(),!1})},FileExplorerMainField.prototype.file_contextmenu=function(e,$file,file_obj){$(".file-explorer-main-field-context-menu").remove();let vw=$(window).width(),vh=$(window).height(),left=e.pageX-.1*vw,top=e.pageY-$(document).scrollTop();left<0&&(left=0);let $menu=$(`<ul class="file-explorer-main-field-context-menu" style="left: ${left}px; top: ${top}px;">`+'<li><div class="file-explorer-main-field-context-menu-open">打开</div></li>'+`${"文件夹"===file_obj.type?'<li><div class="file-explorer-main-field-context-menu-open-outer-window">在新窗口中打开</div></li>':""}`+'<li><div class="file-explorer-main-field-context-menu-cut">剪切</div></li><li><div class="file-explorer-main-field-context-menu-copy">复制</div></li><li><div class="file-explorer-main-field-context-menu-delete">删除</div></li><li><div class="file-explorer-main-field-context-menu-rename">重命名</div></li></ul>');$file.append($menu),$menu.height()+top>.9*vh&&$menu.css("top",.9*vh-$menu.height()+"px"),$menu.menu();let outer_obj=this;$menu.find(".file-explorer-main-field-context-menu-open").click(function(){return file_obj.open(),$menu.remove(),!1}),"文件夹"===file_obj.type&&$menu.find(".file-explorer-main-field-context-menu-open-outer-window").click(function(){return file_obj.open("outer_window"),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-cut").click(function(){return outer_obj.cut(),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-copy").click(function(){return outer_obj.copy(),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-delete").click(function(){return outer_obj.delete_files(),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-rename").click(function(){return file_obj.rename(),$menu.remove(),!1}),$menu.mousedown(function(e){return e.stopPropagation(),e.preventDefault(),!1}),$menu.dblclick(function(e){return e.stopPropagation(),e.preventDefault(),!1})},FileExplorerMainField.prototype.load=function(address,type){type=type||"new";let url=desktop_state.os.builtin.api.file.operation.command_ls,outer_obj=this;$.ajax({type:"GET",url,data:{data:JSON.stringify({type:"address",address})},dataType:"json",success:function(resp){if("success"===resp.error_message){let files=resp.files;outer_obj.clear(),outer_obj.render_files(files),outer_obj.root.nav.set_address(resp.address,type)}else{let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text="+resp.error_message)}},error:function(resp){let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text=系统出现异常，请稍后重试")}})},FileExplorerMainField.prototype.append=function(file_ids,callback){let url=desktop_state.os.builtin.api.file.operation.command_ls,outer_obj=this;$.ajax({type:"GET",url,data:{data:JSON.stringify({type:"file",file_ids})},dataType:"json",success:function(resp){if("success"===resp.error_message){let files=resp.files;outer_obj.render_files(files),callback&&callback(files)}else{let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text="+resp.error_message)}},error:function(resp){let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text=系统出现异常，请稍后重试")}})},FileExplorerMainField.prototype.new_folder=function(){let outer_obj=this;$.ajax({type:"POST",url:desktop_state.os.builtin.api.file.operation.add,data:{data:JSON.stringify({title:"新建文件夹",file_type:"folder",path:outer_obj.root.nav.get_address().real})},dataType:"json",success:function(resp){if("success"===resp.error_message){let file_id=resp.file_id;outer_obj.append([file_id],function(files){for(let i=0;i<outer_obj.files.length;i++)if(outer_obj.files[i].id===files[0].id){outer_obj.files[i].rename();break}})}else{let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text="+resp.error_message)}},error:function(){let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text=系统出现异常，请稍后重试")}})},FileExplorerMainField.prototype.unselect_files=function(){for(let[$file,file_obj]of this.selected_files)$file.removeClass("file-explorer-main-field-item-selected"),file_obj.last_record_time=null;this.selected_files.clear()},FileExplorerMainField.prototype.select_files=function(e,$file,file_obj){let outer_obj=this;if(2===e.which)return!1;if(3===e.which&&this.selected_files.has($file))return!1;if(e.shiftKey){e.ctrlKey||outer_obj.unselect_files(),outer_obj.shift_selected_anchor||(outer_obj.shift_selected_anchor=outer_obj.files[0].$file);let i=0;for(;i<outer_obj.files.length&&outer_obj.files[i].$file!==outer_obj.shift_selected_anchor;)i++;let j=0;for(;j<outer_obj.files.length&&outer_obj.files[j].$file!==$file;)j++;if(i<outer_obj.files.length&&j<outer_obj.files.length){i>j&&([i,j]=[j,i]);for(let k=i;k<=j;k++){let file_k=outer_obj.files[k];file_k.$file.addClass("file-explorer-main-field-item-selected"),outer_obj.selected_files.set(file_k.$file,file_k)}}}else e.ctrlKey?outer_obj.selected_files.has($file)?($file.removeClass("file-explorer-main-field-item-selected"),file_obj.last_record_time=null,outer_obj.selected_files.delete($file)):($file.addClass("file-explorer-main-field-item-selected"),outer_obj.selected_files.set($file,file_obj)):1===outer_obj.selected_files.size&&outer_obj.selected_files.has($file)||(outer_obj.unselect_files(),outer_obj.selected_files.set($file,file_obj),$file.addClass("file-explorer-main-field-item-selected"));e.shiftKey||(outer_obj.shift_selected_anchor=$file),outer_obj.last_selected_file&&outer_obj.last_selected_file.removeClass("file-explorer-main-field-item-selected-last"),$file.addClass("file-explorer-main-field-item-selected-last"),outer_obj.last_selected_file=$file};class FileExplorerMainNavFile extends FileExplorerMainFile{constructor(root,file,p_file){super(root,file),p_file||(p_file=null),this.parent=p_file,this.sons=[],this.render(),this.add_listening_events(),p_file?p_file.add(this):root.main.nav.$nav.append(this.$block),this.state="closed",this.loaded=!1}render(){this.$block=$('<div class="file-explorer-main-nav-item"><div class="file-explorer-main-nav-item-self"><span class="glyphicon glyphicon-chevron-right file-explorer-main-nav-item-self-chevron file-explorer-main-nav-item-self-chevron-closed"></span><div class="file-explorer-main-nav-item-self-icon">'+`<img src="${this.icon}" alt="文件图标">`+"</div>"+`<div class="file-explorer-main-nav-item-self-title">${this.get_full_file_name()}</div>`+'</div><div class="file-explorer-main-nav-item-son"></div></div>'),this.$file=this.$block.find(".file-explorer-main-nav-item-self"),this.$chevron=this.$file.find(".file-explorer-main-nav-item-self-chevron"),this.$icon=this.$file.find(".file-explorer-main-nav-item-self-icon"),this.$title=this.$file.find(".file-explorer-main-nav-item-self-title"),this.$son=this.$block.find(".file-explorer-main-nav-item-son")}open_folder(){this.loaded||this.root.main.nav.load(this.address,this),this.$son.show(),this.$chevron.removeClass("glyphicon-chevron-right").addClass("glyphicon-chevron-down"),this.$chevron.removeClass("file-explorer-main-nav-item-self-chevron-closed").addClass("file-explorer-main-nav-item-self-chevron-open"),this.state="open"}close_folder(){this.$son.hide(),this.$chevron.removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-right"),this.$chevron.removeClass("file-explorer-main-nav-item-self-chevron-open").addClass("file-explorer-main-nav-item-self-chevron-closed"),this.state="closed"}add_listening_events(){let outer_obj=this;this.$file.click(function(){return outer_obj.root.main.nav.$nav.find(".file-explorer-main-nav-item-self-selected").removeClass("file-explorer-main-nav-item-self-selected"),outer_obj.$file.addClass("file-explorer-main-nav-item-self-selected"),outer_obj.open(),!1}),$(window).click(function(){outer_obj.root.main.nav.$nav.find(".file-explorer-main-nav-item-self-selected").removeClass("file-explorer-main-nav-item-self-selected")}),this.$chevron.click(function(){return"closed"===outer_obj.state?outer_obj.open_folder():outer_obj.close_folder(),!1}),this.$file.dblclick(function(){return"closed"===outer_obj.state?outer_obj.open_folder():outer_obj.close_folder(),!1}),this.$file.contextmenu(function(e){return outer_obj.contextmenu(e),!1})}clear(){for(let i=0;i<this.sons.length;i++){let son=this.sons[i];son.clear(),this.root.main.nav.files.delete(son)}this.sons=[],this.$son.empty()}add(s_file){this.sons.push(s_file),this.$son.append(s_file.$block)}}FileExplorerMainNavFile.prototype.contextmenu=function(e){$(".file-explorer-main-field-context-menu").remove();let vw=$(window).width(),vh=$(window).height(),left=e.pageX-.1*vw,top=e.pageY-$(document).scrollTop();left<0&&(left=0);let $menu=$(`<ul class="file-explorer-main-field-context-menu" style="left: ${left}px; top: ${top}px;">`+`<li><div class="file-explorer-main-field-context-menu-open">${"closed"===this.state?"展开":"折叠"}</div></li>`+`${"文件夹"===this.type?'<li><div class="file-explorer-main-field-context-menu-open-outer-window">在新窗口中打开</div></li>':""}`+'<li><div class="file-explorer-main-field-context-menu-refresh">刷新</div></li></ul>');this.$file.append($menu),$menu.height()+top>.9*vh&&$menu.css("top",.9*vh-$menu.height()+"px"),$menu.menu();let outer_obj=this;$menu.find(".file-explorer-main-field-context-menu-open").click(function(){return"closed"===outer_obj.state?outer_obj.open_folder():outer_obj.close_folder(),$menu.remove(),!1}),"文件夹"===outer_obj.type&&$menu.find(".file-explorer-main-field-context-menu-open-outer-window").click(function(){return outer_obj.open("outer_window"),$menu.remove(),!1}),$menu.find(".file-explorer-main-field-context-menu-refresh").click(function(){return outer_obj.loaded=!1,outer_obj.root.main.nav.load(outer_obj.address,outer_obj),$menu.remove(),!1}),$menu.mousedown(function(e){return e.stopPropagation(),e.preventDefault(),!1}),$menu.dblclick(function(e){return e.stopPropagation(),e.preventDefault(),!1})};class FileExplorerMainNav{constructor(root,$main){this.root=root,this.$nav=$main.find(".file-explorer-main-nav"),this.files=new Set,this.add_listen_events()}add_listen_events(){this.$nav.on("mousewheel DOMMouseScroll",function(e){let e0=e.originalEvent,delta=e0.wheelDelta||-e0.detail;this.scrollTop+=50*(delta<0?1:-1),e.preventDefault()})}load(address,p_file){p_file||(p_file=null);let outer_obj=this,url=desktop_state.os.builtin.api.file.operation.command_ls;$.ajax({type:"GET",url,data:{data:JSON.stringify({type:"address",address})},dataType:"json",success:function(resp){if("success"===resp.error_message){let files=resp.files;p_file&&(p_file.clear(),p_file.loaded=!0);for(let i=0;i<files.length;i++){let file=files[i];"文件夹"===file.type&&outer_obj.files.add(new FileExplorerMainNavFile(outer_obj.root,file,p_file))}}else{let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text="+resp.error_message)}},error:function(resp){let w_obj=desktop_state.window.windows[outer_obj.root.window_id];desktop_state.window.open_inner_hard_window(w_obj.file_id,outer_obj.root.window_id,"notice_error&error_text=系统出现异常，请稍后重试")}})}}class FileExplorerMain{constructor(root,$file_explorer){this.root=root,this.$main=$file_explorer.find(".file-explorer-main"),this.nav=new FileExplorerMainNav(root,this.$main),this.field=new FileExplorerMainField(root,this.$main),this.init_resize_logic()}init_resize_logic(){let outer_main=this.$main,outer_nav=this.nav.$nav,outer_field=this.field.$field;outer_nav.resizable({minWidth:"5vw",handles:"e"});let adjust_size=function(){let vw=$(window).width()/100,min_left_width=3*vw,min_right_width=6*vw;outer_nav.width()>outer_main.width()-min_right_width&&outer_nav.width(outer_main.width()-min_right_width),outer_nav.width()<min_left_width&&outer_nav.width(min_left_width),outer_field.width(outer_main.width()-outer_nav.width()-1)};outer_nav.closest(".fs-gui-window").resize(function(){adjust_size()}),$(window).resize(function(){adjust_size()})}}class FileExplorerNav{constructor(root,$file_explorer){this.root=root,this.$nav=$file_explorer.find(".file-explorer-nav"),this.$backward=this.$nav.find(".file-explorer-nav-backward"),this.$forward=this.$nav.find(".file-explorer-nav-forward"),this.$refresh=this.$nav.find(".file-explorer-nav-refresh"),this.$upward=this.$nav.find(".file-explorer-nav-upward"),this.$address=this.$nav.find(".file-explorer-nav-address"),this.address_records=[],this.cur_address=-1,this.disable_backward(),this.disable_forward(),this.add_menu_item_event()}add_menu_item_event(){this.add_menu_item_event_click()}add_menu_item_event_click(){let outer_obj=this;this.$backward.click(function(){outer_obj.go_backward()}),this.$forward.click(function(){outer_obj.go_forward()}),this.$refresh.click(function(){outer_obj.go_refresh()}),this.$upward.click(function(){outer_obj.go_upward()})}get_address(index){return void 0===index&&(index=this.cur_address),0===this.address_records.length?null:this.address_records[index]}get_current_folder(){let files=this.get_address().real.split("/");return parseInt(files[files.length-2])}set_address(address,type){if(type=type||"new",this.$address.val(address.human),"backward"===type)this.cur_address>0&&this.cur_address--;else if("forward"===type)this.cur_address+1<this.address_records.length&&this.cur_address++;else if("new"===type||"upward"===type){if(this.cur_address+1<this.address_records.length){let length=this.address_records.length;this.address_records.splice(this.cur_address+1,length-this.cur_address-1)}this.address_records.push(address),this.cur_address++}this.cur_address>0?this.enable_backward():this.disable_backward(),this.cur_address+1<this.address_records.length?this.enable_forward():this.disable_forward(),"/我的空间/"===address.human?this.disable_upward():this.enable_upward()}go_backward(){this.cur_address>0&&(this.root.main.field.clear(),this.root.main.field.load(this.get_address(this.cur_address-1).real,"backward"))}go_forward(){this.cur_address+1<this.address_records.length&&(this.root.main.field.clear(),this.root.main.field.load(this.get_address(this.cur_address+1).real,"forward"))}go_refresh(){this.root.main.field.refresh()}go_upward(){if("/我的空间/"!==this.get_address().human){let address=this.get_address().real,k=address.length-1,s=0;for(;k>=0&&("/"===address[k]&&s++,2!==s);)k--;address=address.substr(0,k+1),this.root.main.field.clear(),this.root.main.field.load(address,"upward")}}disable_backward(){this.$backward.addClass("file-explorer-nav-button-disabled")}disable_forward(){this.$forward.addClass("file-explorer-nav-button-disabled")}disable_upward(){this.$upward.addClass("file-explorer-nav-button-disabled")}enable_backward(){this.$backward.removeClass("file-explorer-nav-button-disabled")}enable_forward(){this.$forward.removeClass("file-explorer-nav-button-disabled")}enable_upward(){this.$upward.removeClass("file-explorer-nav-button-disabled")}}class FileExplorer{constructor(id,wid,address){this.id=id,this.window_id=wid,this.type=null,this.$file_explorer=$("#"+id),this.nav=new FileExplorerNav(this,this.$file_explorer,address),this.main=new FileExplorerMain(this,this.$file_explorer),address||(address="~/"),this.main.field.load(address,"new"),this.main.nav.load("/",null)}set_type(type){this.type=type,"打开"===type&&(this.footer=new FileExplorerFooterOpen(this,this.$file_explorer))}}
